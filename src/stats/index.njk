---
layout: default
eleventyComputed:
  title: "DefiPlaza Analytics"
  description: "See what DefiPlaza's TVL is, the DFP2 price and market cap, the daily trade volume, and more."
permalink: '/stats/'
---

<section class="md:container mx-4 md:mx-auto">
	<h1 class="text-center text-3xl md:text-6xl font-light"><strong class="font-bold text-primary-500">DefiPlaza's</strong> Analytics</h1>
	<p class="text-center text-base font-bold">Last synced block <span id="lastBlock" class="font-normal">{% include "partials/loading-indicator.njk" %}</span><span id="lastBlockTime"></span></p>

	<div class="relative mt-16 space-y-4 p-4 md:p-8 pt-4 bg-primary-700 rounded-lg md:rounded-3xl overflow-hidden">
		<div class="oval-gradient -top-80 -left-80"></div>

		{# TVL and DFP2 MC #}
		<div class="relative grid grid-cols-1 md:grid-cols-2 gap-4">
			<div class="z-10 py-8 px-4 flex flex-col justify-between rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="tvl">
					<h2 class="text-2xl">Total Value Locked</h2>
					<h3 class="text-2xl text-primary-700">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70">Today</p>
				</div>
				<canvas id="tvlChart" width="400" height="250"></canvas>
			</div>

			<div class="z-10 py-8 px-4 flex flex-col justify-between rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="marketCap">
					<h2 class="text-2xl text-right">DFP2 Market Cap</h2>
					<h3 class="text-2xl text-primary-700 text-right">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70 text-right">Today</p>
				</div>
				<canvas id="marketCapChart" width="400" height="250"></canvas>
			</div>
		</div>

		{# XDP2 and DFP2 prices #}
		<div class="relative grid grid-cols-1 md:grid-cols-2 gap-4">
			<div class="z-10 py-8 px-4 flex flex-col justify-between rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="xdp2Price">
					<h2 class="text-2xl">XDP2 Price</h2>
					<h3 class="text-2xl text-primary-700">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70">Today</p>
				</div>
				<canvas id="xdp2PriceChart" width="400" height="250"></canvas>
			</div>

			<div class="z-10 py-8 px-4 flex flex-col justify-between rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="dfp2Price">
					<h2 class="text-2xl text-right">DFP2 Price</h2>
					<h3 class="text-2xl text-primary-700 text-right">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70 text-right">Today</p>
				</div>
				<canvas id="dfp2PriceChart" width="400" height="250"></canvas>
			</div>
		</div>

		{# Daily Trade Volume #}
		<div class="relative grid grid-cols-1 gap-4">
			<div class="z-10 py-16 px-8 flex flex-col rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="swap">
					<h2 class="text-2xl">Daily Trade Volume</h2>
					<h3 class="text-2xl text-primary-700">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70">Today</p>
				</div>
				<canvas id="swapChart" width="800" height="250"></canvas>
			</div>
		</div>

		{# Daily Liquidity Change #}
		<div class="relative grid grid-cols-1 gap-4">
			<div class="z-10 py-8 px-4 flex flex-col rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<div id="liquidity">
					<h2 class="text-2xl">Daily Liquidity Change</h2>
					<h3 class="text-2xl text-primary-700">{% include "partials/loading-indicator.njk" %}</h3>
					<p class="text-base text-black/70">Today</p>
				</div>
				<canvas id="liquidityChart" width="800" height="250"></canvas>
			</div>
		</div>

		{# Tokens #}
		<div class="relative grid grid-cols-1 gap-4">
			<div class="z-10 py-8 px-4 flex flex-col rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<h2 class="text-2xl">Tokens</h2>
				<div class="mt-4 relative bg-slate-50 rounded-xl overflow-hidden nodark:bg-slate-800/25">
					<div class="relative rounded-xl overflow-auto">
						<div id="tokens" class="shadow-sm overflow-hidden my-8">
							{% include "partials/loading-indicator.njk" %}
						</div>
					</div>
				</div>
			</div>
		</div>

		{# Recent Transactions #}
		<div class="relative grid grid-cols-1 gap-4">
			<div class="z-10 py-16 px-8 flex flex-col rounded-lg shadow-md bg-white hover:shadow-xl transition-shadow duration-300 ease-in-out content-between">
				<h2 class="text-2xl">Recent Transactions</h2>
				<div class="mt-4 relative bg-slate-50 rounded-xl overflow-hidden nodark:bg-slate-800/25">
					<div class="relative rounded-xl overflow-auto">
						<div id="transactions" class="shadow-sm overflow-hidden my-8">
							{% include "partials/loading-indicator.njk" %}
						</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js" integrity="sha256-bC3LCZCwKeehY6T4fFi9VfOU0gztUa+S4cnkIhVPZ5E=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/plugin/relativeTime.js"></script>

<script type="text/javascript">
jQuery(document).ready(function () { 
    dayjs.extend(window.dayjs_plugin_relativeTime)
    
	const queryBody = JSON.stringify({
    	query: `{
    	    factories(first: 1) {
    	        totalValueLockedUSD
    	    }
    	    transactions(first: 1, orderBy: timestamp, orderDirection: desc) {
                blockNumber
                timestamp
              }
    	    dailies(first: 90, orderBy: date, orderDirection: desc) {
                date
                liquidityUSD
                tradeVolumeUSD
                swapUSD
                totalValueLockedUSD
                dfp2MarketCap
                xdp2TotalSupply
            }
            dailyTokens(first: 90, where: { token:\"0x2f57430a6ceda85a67121757785877b4a71b8e6d\" }, orderBy: date, orderDirection: desc) {
                date
                tokenPriceUSD
                tokenPriceMin
                tokenPriceMax
            }
            swaps(first: 20, orderBy: timestamp, orderDirection: desc) {
                id
                timestamp
                inputToken {
                  symbol
                  tokenPriceUSD
                }
                inputAmount
                outputToken {
                  symbol
                  tokenPriceUSD
                }
                outputAmount
                swapUSD
            }
            tokens(first: 16, orderBy: tokenAmount, orderDirection: desc) {
                id
                symbol
                tokenAmount
                tokenPriceUSD
            } 
            _meta(id:null) {
                block {
                  number
                }
                deployment
                hasIndexingErrors
              }
    	}`
	});
	
	fetch('https://api.thegraph.com/subgraphs/name/omegasyndicate/defiplaza', {
			method: 'post',
			headers: {
				'Content-Type': 'application/json'
			},
			body: queryBody
		})
		.then(function(result) { return result.json() })
		.then(function(jsonResult) {
		    return jsonResult.data;
		})
	    .then(function(graphData) {
	        // Do a health check on subgraph synced
	        healthCheck(graphData._meta.block.number);
	        
	        // Display TVL
		    var tvl = graphData.factories[0].totalValueLockedUSD;
		
 			// Make last day, the first day
 			graphData.dailies.reverse();
 			graphData.dailyTokens.reverse();
 			
 			// Build graphs
 			tvlChart(graphData.dailies);
 			marketCapChart(graphData.dailies);
 			
 			xdp2Chart(graphData.dailies);
 			dfp2PriceChart(graphData.dailyTokens);
 			
 			liquidityChart(graphData.dailies);
 			
 			swapChart(graphData.dailies);
 			
 			// Build tables
 			tokensTable(graphData.tokens);
 			
 			transactionsTable(graphData.swaps);
 		});

});

let coingeckoPrices;
let coingeckoTokens = {
	"AAVE": "aave",
	"COMP": "compound-governance-token",
	"CRV": "curve-dao-token",
	"DAI": "dai",
	"ETH": "ethereum",
	"eXRD": "e-radix",
	"LINK": "chainlink",
	"MATIC": "matic-network",
	"MKR": "maker",
	"SPELL": "spell-token",
	"SUSHI": "sushi",
	"UNI": "uniswap",
	"USDC": "usd-coin",
	"USDT": "tether",
	"WBTC": "wrapped-bitcoin",
	"YFI": "yearn-finance"
};
let chartScales = {
	y: {
		beginAtZero: true,
		position: 'right',
		ticks: {
			color: "#23211f",
			font: {
				size: 12
			},
      	// Include a dollar sign in the ticks
			callback: function (value, index, values) {
				return prettyDollar(parseFloat(value));
			},
		},
		/*grid: {
			borderColor: 'rgb(236, 198, 168)',
			color: 'rgba(47, 79, 126, 0.1)',
		},*/
		grid: {
			display: false,
			drawBorder: false,
		},
		display: false
	},
	x: {
		/*grid: {
			borderColor: 'rgb(236, 198, 168)',
			color: 'rgba(47, 79, 126, 0.1)',
		},*/
		ticks: {
			color: "#23211f",
			font: {
				size: 12
			},
			/*callback: function(val, index) {
            // Hide every 2nd tick label
            return index % 7 === 0 ? this.getLabelForValue(val) : '';
          }*/
		},
		grid: {
			display: false,
			drawBorder: false,
		},
		display: false
	},
};
let weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

function getCoinGeckoPrices() {
    let tokens = [];
    
    for(let symbol in coingeckoTokens) {
        tokens.push(coingeckoTokens[symbol]);
    }
    
    return fetch(`https://api.coingecko.com/api/v3/simple/price/?` + new URLSearchParams({
    	    ids: tokens.join(','),
    		vs_currencies: 'USD',
	    }), {
		method: 'GET', 
	})
	.then(response => response.json())
	.then((data) => {
	    coingeckoPrices = data;
	});
}

function getPrice(token) {
   if(coingeckoPrices[coingeckoTokens[token.symbol]]) {
        return coingeckoPrices[coingeckoTokens[token.symbol]].usd
    }
    
    return token.tokenPriceUSD;
}

function prettyDollar(value) {
    return "$" + prettyValue(value);
}
function prettyValue(v) {
    var size = "M";
	var prettyValue;
	var sign = v < 0 ? '-' : '';
	var value = Math.abs(v);
			
	if(value < 1) {
		prettyValue = parseFloat(value).toFixed(3);
		size = ""
	} else if(value < 1000) {
		prettyValue = parseFloat(value).toFixed(2);
		size = ""
	} else if(value < 10000) {
		prettyValue = Math.round(value);
		size = ""
	} else if(value < 100000) {
		prettyValue = parseFloat(value/1000).toFixed(1);
		size = "K"
	} else if(value < 1000000) {
		prettyValue = Math.round(value/1000);
		size = "K"
	} else {
		prettyValue = parseFloat(value/1000000).toFixed(2);
	}

    return sign + prettyValue.toLocaleString() + size;
}

function tvlChart(dailies) {
   lineChart('tvl', 'Total Value Locked', dailies, 'totalValueLockedUSD', true); 
}

function marketCapChart(dailies) {
	lineChart('marketCap', 'DFP2 Market Cap', dailies, 'dfp2MarketCap', true); 
}

function dfp2PriceChart(dailies) {
	lineChart('dfp2Price', 'DFP2 price in USD', dailies, 'tokenPriceUSD', false);
}

function swapChart(dailies) {
	lineChart('swap', 'Daily Trade Volume', dailies, 'tradeVolumeUSD', true);
}

function liquidityChart(dailies) {
	barChart('liquidity', 'Daily Liquidity Change', dailies, 'liquidityUSD');
}

function xdp2Chart(dataPoints) {
	let labels = [];
	let data = [];
	let pointBorderColors = [];
	let pointBackgroundColors = [];

	for (let point of dataPoints) {
		point.tokenPriceUSD = point['totalValueLockedUSD']/point['xdp2TotalSupply'];
		
		data.push(point);
	}

	lineChart('xdp2Price', 'XDP2 price in USD', data, 'tokenPriceUSD', false);
}

function tokensTable(tokens) {
    
    getCoinGeckoPrices().then(function(coingeckoPrices) {
        tokens.sort(function(a,b) {
            if(a.tokenAmount*getPrice(a) < b.tokenAmount*getPrice(b)) {
                return 1;
            }
            
            return -1;
        });
    
        let table = `
            <table class="border-collapse table-auto w-full text-sm">
            <thead>
            <tr>
                <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Symbol</td>
                <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Liquidity</td>
                <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Token amount</td>
                <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Price</td>
            </tr>
            </thead><tbody class="bg-white nodark:bg-slate-800">`;
        
        for(let token of tokens) {
            table += `<tr>
            	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400"><a href="/token/${token.symbol.toLowerCase()}">${token.symbol}</a></td>
            	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyDollar(token.tokenAmount*getPrice(token)) }</td>
             	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyValue(token.tokenAmount) }</td>
            	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyDollar(getPrice(token)) }</td>
            </tr>`;
        }
        
        table += `</tbody></table>`;
            
        jQuery("#tokens").html(table);
    });
}

function transactionsTable(swaps) {
    let table = `
        <table class="border-collapse table-auto w-full text-sm">
        <thead>
        <tr>
            <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left"></td>
            <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Total Value</td>
            <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Token amount</td>
            <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Token amount</td>
            <td class="border-b nodark:border-slate-600 font-medium p-4 pl-8 pt-0 pb-3 text-slate-400 nodark:text-slate-200 text-left">Date</td>
        </tr>
        </thead>
		  <tbody class="bg-white nodark:bg-slate-800">`;
    
    for(let swap of swaps) {
        table += `<tr>
      	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400"><a href="https://etherscan.io/tx/${ swap.id }" target="_blank">From ${swap.inputToken.symbol} to ${swap.outputToken.symbol}</a></td>
      	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyDollar(swap.swapUSD) }</td>
      	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyValue(swap.inputAmount) } ${swap.inputToken.symbol}</td>
        	<td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ prettyValue(swap.outputAmount) } ${swap.outputToken.symbol}</td>
         <td class="border-b border-slate-100 nodark:border-slate-700 p-4 pl-8 text-slate-500 nodark:text-slate-400">${ dayjs(swap.timestamp*1000).fromNow() } </td>
        </tr>`;
    }
    
    table += `</tbody></table>`;
        
    jQuery("#transactions").html(table);
    
}

function lineChart(id, label, dataPoints, dataPoint, fill) {
	let labels = [];
	let data = [];
	let pointBorderColors = [];
	let pointBackgroundColors = [];

	for (let point of dataPoints) {
		let date = new Date(point.date * 1000);
		labels.push(weekdays[date.getDay()] + ' ' + date.getDate() + '/' + (date.getMonth() + 1));
		data.push(point[dataPoint]);
	}

	jQuery(`#${id} h3`).text(prettyDollar(data[data.length - 1]));

	labels[labels.length - 1] = 'Today';
	pointBorderColors[pointBorderColors.length - 1] = 'rgba(47, 79, 126, 0.5)';
	pointBackgroundColors[pointBackgroundColors.length - 1] = 'rgba(47, 79, 126, 0.2)';

	const ctx = document.getElementById(id + 'Chart').getContext('2d');
	const myChart = new Chart(ctx, {
		type: 'line',
		data: {
			labels: labels,
			datasets: [
				{
					label: label,
					data: data,
					backgroundColor: '#3d028380',
					borderWidth: 3,
					fill: fill,
					borderColor: '#3d0283',
					pointRadius: 0,
					pointHoverRadius: 6,
					pointHoverBorderWidth: 2,
					pointHoverBorderColor: '#3d0283',
					pointHoverBackgroundColor: '#ffffff80',
					lineTension: 0.05,
					segment: {
						backgroundColor: function (ctx) {
							if (ctx.p0DataIndex == data.length - 2) {
								return 'rgba(47, 79, 126, 0.2)';
							}
							return undefined;
						},
						borderDash: function (ctx) {
							if (ctx.p0DataIndex == data.length - 2) {
								return [2, 2];
							}
							return undefined;
						},
					},
				},
			],
		},
		options: {
			interaction: {
				mode: 'index',
				intersect: false,
			},
			plugins: {
				legend: {
					display: false,
				},
				tooltip: {
					enabled: false,
					position: 'nearest',
					usePointStyle: true,
					external: function(context) {
						var raw = context.tooltip.dataPoints[0].raw;
						var title = context.tooltip.title[0];
						
						jQuery(`#${id} h3`).text(prettyDollar(raw));
						jQuery(`#${id} p`).text(title);

					}
				}			
			},
			scales: chartScales
		},
	});
}

function barChart(id, label, dataPoints, dataPoint) {
	let labels = [];
	let data = [];
	let backgroundColors = [];

	for (let point of dataPoints) {
		let date = new Date(point.date * 1000);
		labels.push(weekdays[date.getDay()] + ' ' + date.getDate() + '/' + (date.getMonth() + 1));
		data.push(point[dataPoint]);

		backgroundColors.push('#3d028380');
	}

	labels[labels.length - 1] = 'Today';
	backgroundColors[backgroundColors.length - 1] = 'rgba(47, 79, 126, 0.2)';

	jQuery(`#${id} h3`).text(prettyDollar(data[data.length - 1]));

	const ctx = document.getElementById(id + 'Chart').getContext('2d');
	const myChart = new Chart(ctx, {
		type: 'bar',
		data: {
			labels: labels,
			datasets: [
				{
					label: label,
					data: data,
					backgroundColor: backgroundColors,
					borderColor: ['#3d0283'],
					borderWidth: 0,
					fill: true,
					pointStyle: 'circle'
				},
			],
		},
		options: {
			plugins: {
				legend: {
					display: false,
				},
				tooltip: {
					enabled: false,
					position: 'nearest',
					usePointStyle: true,
					external: function(context) {
						var raw = context.tooltip.dataPoints[0].raw;
						var title = context.tooltip.title[0];
						
						jQuery(`#${id} h3`).text(prettyDollar(raw));
						jQuery(`#${id} p`).text(title);

					}
				}	
			},
			scales: chartScales,
		},
	});
}

function healthCheck(lastestBlockNumber) {
    const healthBody = JSON.stringify({
    	query: `{
          indexingStatusForCurrentVersion(subgraphName: "omegasyndicate/defiplaza") {
            synced
            health
            fatalError {
              message
              block {
                number
                hash
              }
              handler
            }
            chains {
              chainHeadBlock {
                number
              }
              latestBlock {
                number
              }
            }
          }
        }`
    });
    
    fetch('https://api.thegraph.com/index-node/graphql', {
			method: 'post',
			headers: {
				'Content-Type': 'application/json'
			},
			body: healthBody
		})
		.then(function(result) { return result.json() })
		.then(function(jsonResult) {
		    return jsonResult.data;
		})
	    .then(function(graphData) {
	       
	       
	       // Latest TheGraph block
	       var lastestTheGraphBlock = graphData.indexingStatusForCurrentVersion.chains[0].latestBlock.number;
	       var diff = lastestTheGraphBlock - lastestBlockNumber;
	       
	       // Display last block synced
	       jQuery("#lastBlock").html(`<a href="https://etherscan.io/block/${lastestBlockNumber}" target="_blank">${lastestBlockNumber}</a>`);
	       
	       // Display warning banner, when more than 1 block difference
	       if(diff > 4) {
	          jQuery("#blockDiff").html(diff);
	          jQuery("#warning-banner").show();
	       }
	    });
}
</script>